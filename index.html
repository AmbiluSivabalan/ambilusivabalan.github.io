<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.3/dist/tailwind.min.css" rel="stylesheet">
    <title>Productivity App</title>
    <style>
        [data-theme="work"] { background-color: #A7F3D0; }
        [data-theme="break"] { background-color: #93C5FD; }
    </style>
</head>
<body class="bg-gray-100" data-theme="work">
    <div class="container mx-auto px-4 py-12">
        <h1 class="text-4xl font-bold mb-8">Productivity App</h1>

        <!-- Pomodoro Timer -->
        <div id="pomodoro-timer" class="bg-white p-6 rounded shadow-lg mb-8">
            <h2 class="text-2xl mb-4">Pomodoro Timer</h2>
            <div class="flex items-center mb-4">
                <input id="work-duration" type="number" min="1" value="25" class="border-2 border-gray-300 p-2 w-16 text-center" required> Work
                <input id="break-duration" type="number" min="1" value="5" class="border-2 border-gray-300 p-2 w-16 text-center ml-4" required> Break
            </div>
            <div class="flex items-center">
                <button id="start-pomodoro" class="bg-green-500 text-white px-4 py-2 rounded shadow mr-4">Start</button>
                <button id="reset-pomodoro" class="bg-red-500 text-white px-4 py-2 rounded shadow">Reset</button>
            </div>
            <div id="timer" class="text-4xl font-bold mt-4">25:00</div>
            <div id="timer-mode" class="text-xl font-bold mt-4">Work</div>
            <div class="mt-4">
                <p id="cycles-completed">Cycles completed: 0</p>
                <p id="tasks-finished">Tasks finished: 0</p>
            </div>
        </div>

        <!-- Task List -->
        <div id="task-list" class="bg-white p-6 rounded shadow-lg mb-8">
            <h2 class="text-2xl mb-4">Task List</h2>
            <form id="add-task-form" class="mb-4">
                <input id="task-input" type="text" class="border-2 border-gray-300 p-2 w-full mb-2 placeholder-gray-500" placeholder="Task" required>
                <input id="due-date-input" type="datetime-local" class="border-2 border-gray-300 p-2 w-full mb-2" required>
                <button class="bg-blue-500 text-white px-4 py-2 rounded shadow">Add Task</button>
            </form>
            <ul id="task-list-items"></ul>
        </div>

        <!-- Time until stopping widget -->
        <div id="stop-time-widget" class="bg-white p-6 rounded shadow-lg">
            <h2 class="text-2xl mb-4">Time until stopping</h2>
            <div id="time-until-stopping" class="text-4xl font-bold mb-4"></div>
            <input id="stop-time-input" type="time" class="border-2 border-gray-300 p-2 w-full mb-2" required>
            <button id="set-stop-time" class="bg-blue-500 text-white px-4 py-2 rounded shadow">Set Stop Time</button>
        </div>
    </div>

    <script>
        const startPomodoro = document.getElementById('start-pomodoro');
        const resetPomodoro = document.getElementById('reset-pomodoro');
        const timer = document.getElementById('timer');
        const timerMode = document.getElementById('timer-mode');
        const workDurationInput = document.getElementById('work-duration');
        const breakDurationInput = document.getElementById('break-duration');
        const addTaskForm = document.getElementById('add-task-form');
        const taskInput = document.getElementById('task-input');
        const dueDateInput = document.getElementById('due-date-input');
        const taskListItems = document.getElementById('task-list-items');
        const stopTimeInput = document.getElementById('stop-time-input');
        const setStopTime = document.getElementById('set-stop-time');
        const timeUntilStopping = document.getElementById('time-until-stopping');
        const cyclesCompleted = document.getElementById('cycles-completed');
        const tasksFinished = document.getElementById('tasks-finished');
        const body = document.body;

        let cyclesCount = 0;
        let tasksCount = 0;

        function increaseCyclesCounter() {
            cyclesCount++;
            cyclesCompleted.textContent = 'Cycles completed: ' + cyclesCount;
        }

        function increaseTasksCounter() {
            tasksCount++;
            tasksFinished.textContent = 'Tasks finished: ' + tasksCount;
        }

        // Pomodoro timer
        let interval;
        let workDuration = workDurationInput.value * 60;
        let breakDuration = breakDurationInput.value * 60;
        let timeLeft = workDuration;
        let isWork = true;

        function updateTime() {
            let minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerMode.textContent = isWork ? 'Work' : 'Break';
        }

        function startTimer() {
            clearInterval(interval);

            workDuration = workDurationInput.value * 60;
            breakDuration = breakDurationInput.value * 60;

            interval = setInterval(() => {
                timeLeft--;

                if (timeLeft < 0) {
                    isWork = !isWork;
                    body.setAttribute('data-theme', isWork ? 'work' : 'break');
                    timeLeft = (isWork ? workDuration : breakDuration);
                    if (isWork) {
                        increaseCyclesCounter();
                    } else {
                        increaseTasksCounter();
                    }
                }

                updateTime();
            }, 1000);
        }

        function resetTimer() {
            clearInterval(interval);
            workDuration = workDurationInput.value * 60;
            breakDuration = breakDurationInput.value * 60;
            timeLeft = workDuration;
            isWork = true;
            body.setAttribute('data-theme', 'work');
            updateTime();
        }

        startPomodoro.onclick = startTimer;
        resetPomodoro.onclick = resetTimer;

        resetTimer();

        // Task list
        let taskList = JSON.parse(localStorage.getItem("throw-treat-tasks")) || [];

        function renderTasks() {
            taskListItems.innerHTML = "";

            taskList.forEach((task, index) => {
                const dueDate = new Date(task.dueDate);
                const currentTime = new Date();
                const timeLeft = Math.max(0, Math.floor((dueDate - currentTime) / 1000));
                const hoursLeft = Math.floor(timeLeft / 3600);
                let timeLeftStr = `${hoursLeft}h`;

                const li = document.createElement('li');
                li.innerHTML = `<span>${task.title} - due in ${timeLeftStr}</span> <button class="bg-red-500 text-white px-2 py-1 rounded shadow" data-index="${index}">Delete</button>`;
                taskListItems.appendChild(li);
            });

            const deleteButtons = document.querySelectorAll('[data-index]');

            deleteButtons.forEach((button) => {
                button.onclick = (e) => {
                    const indexToRemove = parseInt(e.target.getAttribute('data-index'));
                    taskList.splice(indexToRemove, 1);
                    localStorage.setItem("throw-treat-tasks", JSON.stringify(taskList));
                    renderTasks();
                };
            });
        }

        addTaskForm.onsubmit = (e) => {
            e.preventDefault();

            taskList.push({ title: taskInput.value, dueDate: dueDateInput.value });
            localStorage.setItem("throw-treat-tasks", JSON.stringify(taskList));
            taskInput.value = "";
            dueDateInput.value = "";
            renderTasks();
        };

        renderTasks();

        // Time until stopping
        let stopTime = localStorage.getItem("throw-treat-stop-time");

        if (stopTime) {
            stopTimeInput.value = stopTime;
        }

        function updateTimeUntilStopping() {
            const currentTime = new Date();
            const stopTimeDate = new Date(currentTime.toDateString() + ' ' + stopTime);
            
            if (currentTime > stopTimeDate) {
                stopTimeDate.setDate(stopTimeDate.getDate() + 1);
            }

            let timeLeftToStop = Math.floor((stopTimeDate - currentTime) / 1000);
            let hours = Math.floor(timeLeftToStop / 3600);
            timeLeftToStop %= 3600;
            let minutes = Math.floor(timeLeftToStop / 60);
            let seconds = timeLeftToStop % 60;
            timeUntilStopping.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        setStopTime.onclick = () => {
            stopTime = stopTimeInput.value;
            localStorage.setItem("throw-treat-stop-time", stopTime);
            updateTimeUntilStopping();
        };

        setInterval(updateTimeUntilStopping, 1000);

    </script>
</body>
</html>
